<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Barry Wittman, Tim Korb, Aditya Mathur">
<title>Start Concurrent: A Gentle Introduction to Concurrent Programming</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="style0.css" type="text/css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="style1.css" type="text/css">
<link rel="stylesheet" href="asciidoctor-chunker.css" type="text/css"></head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Start Concurrent: A Gentle Introduction to Concurrent Programming</h1>
<div class="details">
<span id="author" class="author">Barry Wittman</span><br>
<span id="email" class="email"><a href="mailto:wittman1@otterbein.edu">wittman1@otterbein.edu</a></span><br>
<span id="author2" class="author">Tim Korb</span><br>
<span id="email2" class="email"><a href="mailto:jtk@purdue.edu">jtk@purdue.edu</a></span><br>
<span id="author3" class="author">Aditya Mathur</span><br>
<span id="email3" class="email"><a href="mailto:apm@purdue.edu">apm@purdue.edu</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="index.html">Attacking Problems with Java</a></li><li><a href="index.html">1. Computer Basics</a>
<ul class="sectlevel2">
<li><a href="index.html#_problem_buying_a_computer">1.1. Problem: Buying a computer</a></li>
<li><a href="index.html#_concepts_hardware_and_software">1.2. Concepts: Hardware and software</a></li>
<li><a href="index.html#_syntax_data_representation">1.3. Syntax: Data representation</a></li>
<li><a href="index.html#_solution_buying_a_computer">1.4. Solution: Buying a computer</a></li>
<li><a href="index.html#_summary">1.5. Summary</a></li>
<li><a href="index.html#_exercises">1.6. Exercises</a></li>
</ul>
</li>
<li><a href="chap2.html">2. Problem Solving and Programming</a>
<ul class="sectlevel2">
<li><a href="chap2.html#_problem_how_to_solve_problems">2.1. Problem: How to solve problems</a></li>
<li><a href="chap2.html#_concepts_developing_software">2.2. Concepts: Developing software</a></li>
<li><a href="chap2.html#_syntax_java_basics">2.3. Syntax: Java basics</a></li>
<li><a href="chap2.html#_solution_how_to_solve_problems">2.4. Solution: How to solve problems</a></li>
<li><a href="chap2.html#_concurrency_solving_problems_in_parallel">2.5. Concurrency: Solving problems in parallel</a></li>
<li><a href="chap2.html#_summary_2">2.6. Summary</a></li>
<li><a href="chap2.html#_exercises_2">2.7. Exercises</a></li>
</ul>
</li>
<li><a href="chap3.html">3. Primitive Types and Strings</a>
<ul class="sectlevel2">
<li><a href="chap3.html#_problem_college_cost_calculator">3.1. Problem: College cost calculator</a></li>
<li><a href="chap3.html#_concepts_types">3.2. Concepts: Types</a></li>
<li><a href="chap3.html#_syntax_types_in_java">3.3. Syntax: Types in Java</a></li>
<li><a href="chap3.html#_syntax_useful_libraries">3.4. Syntax: Useful libraries</a></li>
<li><a href="chap3.html#_solution_college_cost_calculator">3.5. Solution: College cost calculator</a></li>
<li><a href="chap3.html#_concurrency_expressions">3.6. Concurrency: Expressions</a></li>
<li><a href="chap3.html#_summary_3">3.7. Summary</a></li>
<li><a href="chap3.html#_exercises_3">3.8. Exercises</a></li>
</ul>
</li>
<li><a href="chap4.html">4. Selection</a>
<ul class="sectlevel2">
<li><a href="chap4.html#_problem_monty_hall_simulation">4.1. Problem: Monty Hall simulation</a></li>
<li><a href="chap4.html#_concepts_choosing_between_options">4.2. Concepts: Choosing between options</a></li>
<li><a href="chap4.html#_syntax_selection_in_java">4.3. Syntax: Selection in Java</a></li>
<li><a href="chap4.html#_solution_monty_hall">4.4. Solution: Monty Hall</a></li>
<li><a href="chap4.html#_concurrency_selection">4.5. Concurrency: Selection</a></li>
<li><a href="chap4.html#_exercises_4">4.6. Exercises</a></li>
</ul>
</li>
<li><a href="chap5.html">5. Repetition</a>
<ul class="sectlevel2">
<li><a href="chap5.html#_problem_dna_searching">5.1. Problem: DNA searching</a></li>
<li><a href="chap5.html#_concepts_repetition">5.2. Concepts: Repetition</a></li>
<li><a href="chap5.html#_syntax_loops_in_java">5.3. Syntax: Loops in Java</a></li>
<li><a href="chap5.html#_solution_dna_searching">5.4. Solution: DNA searching</a></li>
<li><a href="chap5.html#_concurrency_loops">5.5. Concurrency: Loops</a></li>
<li><a href="chap5.html#_exercises_5">5.6. Exercises</a></li>
</ul>
</li>
<li><a href="chap6.html">6. Arrays</a>
<ul class="sectlevel2">
<li><a href="chap6.html#_introduction">6.1. Introduction</a></li>
<li><a href="chap6.html#_problem_game_of_life">6.2. Problem: Game of Life</a></li>
<li><a href="chap6.html#_concepts_lists_of_data">6.3. Concepts: Lists of data</a></li>
<li><a href="chap6.html#_syntax_arrays_in_java">6.4. Syntax: Arrays in Java</a></li>
<li><a href="chap6.html#_examples_array_usage">6.5. Examples: Array usage</a></li>
<li><a href="chap6.html#_concepts_multidimensional_lists">6.6. Concepts: Multidimensional lists</a></li>
<li><a href="chap6.html#_syntax_advanced_arrays_in_java">6.7. Syntax: Advanced arrays in Java</a></li>
<li><a href="chap6.html#_examples_two_dimensional_arrays">6.8. Examples: Two-dimensional arrays</a></li>
<li><a href="chap6.html#_advanced_special_array_tools_in_java">6.9. Advanced: Special array tools in Java</a></li>
<li><a href="chap6.html#_solution_game_of_life">6.10. Solution: Game of Life</a></li>
<li><a href="chap6.html#_concurrency_arrays">6.11. Concurrency: Arrays</a></li>
<li><a href="chap6.html#_exercises_6">6.12. Exercises</a></li>
</ul>
</li>
<li><a href="chap7.html">7. Simple Graphical User Interfaces</a>
<ul class="sectlevel2">
<li><a href="chap7.html#_problem_codon_extractor">7.1. Problem: Codon extractor</a></li>
<li><a href="chap7.html#GUIBasicsIntroductionSection">7.2. Concepts: User interaction</a></li>
<li><a href="chap7.html#_syntax_dialogs_and_the_joptionpane_class">7.3. Syntax: Dialogs and the <code>JOptionPane</code> class</a></li>
<li><a href="chap7.html#_solution_codon_extractor">7.4. Solution: Codon extractor</a></li>
<li><a href="chap7.html#_concurrency_simple_guis">7.5. Concurrency: Simple GUIs</a></li>
<li><a href="chap7.html#_summary_4">7.6. Summary</a></li>
<li><a href="chap7.html#_exercises_7">7.7. Exercises</a></li>
</ul>
</li>
<li><a href="chap8.html">8. Methods</a>
<ul class="sectlevel2">
<li><a href="chap8.html#_problem_three_card_poker">8.1. Problem: Three card poker</a></li>
<li><a href="chap8.html#_concepts_dividing_work_into_segments">8.2. Concepts: Dividing work into segments</a></li>
<li><a href="chap8.html#_syntax_methods">8.3. Syntax: Methods</a></li>
<li><a href="chap8.html#_examples_defining_methods">8.4. Examples: Defining methods</a></li>
<li><a href="chap8.html#_solution_three_card_poker">8.5. Solution: Three card poker</a></li>
<li><a href="chap8.html#_concurrency_methods">8.6. Concurrency: Methods</a></li>
<li><a href="chap8.html#_exercises_8">8.7. Exercises</a></li>
</ul>
</li>
<li><a href="chap9.html">9. Classes</a>
<ul class="sectlevel2">
<li><a href="chap9.html#_problem_nested_expressions">9.1. Problem: Nested expressions</a></li>
<li><a href="chap9.html#_concepts_object_oriented_programming">9.2. Concepts: Object-oriented programming</a></li>
<li><a href="chap9.html#_syntax_classes_in_java">9.3. Syntax: Classes in Java</a></li>
<li><a href="chap9.html#_advanced_nested_classes">9.4. Advanced: Nested classes</a></li>
<li><a href="chap9.html#_solution_nested_expressions">9.5. Solution: Nested expressions</a></li>
<li><a href="chap9.html#_concurrency_objects">9.6. Concurrency: Objects</a></li>
<li><a href="chap9.html#_exercises_9">9.7. Exercises</a></li>
</ul>
</li>
<li><a href="chap10.html">10. Interfaces</a>
<ul class="sectlevel2">
<li><a href="chap10.html#_problem_sort_it_out">10.1. Problem: Sort it out</a></li>
<li><a href="chap10.html#_concepts_making_a_promise">10.2. Concepts: Making a promise</a></li>
<li><a href="chap10.html#_syntax_interfaces">10.3. Syntax: Interfaces</a></li>
<li><a href="chap10.html#_advanced_local_and_anonymous_classes">10.4. Advanced: Local and anonymous classes</a></li>
<li><a href="chap10.html#_solution_sort_it_out">10.5. Solution: Sort it out</a></li>
<li><a href="chap10.html#_concurrency_interfaces">10.6. Concurrency: Interfaces</a></li>
<li><a href="chap10.html#_exercises_10">10.7. Exercises</a></li>
</ul>
</li>
<li><a href="chap11.html">11. Inheritance</a>
<ul class="sectlevel2">
<li><a href="chap11.html#_problem_boolean_circuits">11.1. Problem: Boolean circuits</a></li>
<li><a href="chap11.html#_concepts_refining_classes">11.2. Concepts: Refining classes</a></li>
<li><a href="chap11.html#_syntax_inheritance_in_java">11.3. Syntax: Inheritance in Java</a></li>
<li><a href="chap11.html#_examples_problem_solving_with_inheritance">11.4. Examples: Problem solving with inheritance</a></li>
<li><a href="chap11.html#_solution_boolean_circuits">11.5. Solution: Boolean circuits</a></li>
<li><a href="chap11.html#_concurrency_inheritance">11.6. Concurrency: Inheritance</a></li>
<li><a href="chap11.html#_exercises_11">11.7. Exercises</a></li>
</ul>
</li>
<li><a href="chap12.html">12. Exceptions</a>
<ul class="sectlevel2">
<li><a href="chap12.html#_problem_bank_burglary">12.1. Problem: Bank burglary</a></li>
<li><a href="chap12.html#_concepts_error_handling">12.2. Concepts: Error handling</a></li>
<li><a href="chap12.html#_syntax_exceptions_in_java">12.3. Syntax: Exceptions in Java</a></li>
<li><a href="chap12.html#_solution_bank_burglary">12.4. Solution: Bank burglary</a></li>
<li><a href="chap12.html#_concurrency_exceptions">12.5. Concurrency: Exceptions</a></li>
<li><a href="chap12.html#_exercises_12">12.6. Exercises</a></li>
</ul>
</li>
<li class="current"><a href="chap13.html">13. Concurrent Programming</a>
<ul class="sectlevel2">
<li class="current"><a href="chap13.html#_introduction_2">13.1. Introduction</a></li>
<li class="current"><a href="chap13.html#_problem_deadly_virus">13.2. Problem: Deadly virus</a></li>
<li class="current"><a href="chap13.html#_concepts_splitting_up_work">13.3. Concepts: Splitting up work</a></li>
<li class="current"><a href="chap13.html#_syntax_threads_in_java">13.4. Syntax: Threads in Java</a></li>
<li class="current"><a href="chap13.html#_examples_concurrency_and_speedup">13.5. Examples: Concurrency and speedup</a></li>
<li class="current"><a href="chap13.html#_concepts_thread_scheduling">13.6. Concepts: Thread scheduling</a></li>
<li class="current"><a href="chap13.html#_syntax_thread_states">13.7. Syntax: Thread states</a></li>
<li class="current"><a href="chap13.html#_solution_deadly_virus">13.8. Solution: Deadly virus</a></li>
<li class="current"><a href="chap13.html#_summary_5">13.9. Summary</a></li>
<li class="current"><a href="chap13.html#_exercises_13">13.10. Exercises</a></li>
</ul>
</li>
<li><a href="chap14.html">14. Synchronization</a>
<ul class="sectlevel2">
<li><a href="chap14.html#_introduction_3">14.1. Introduction</a></li>
<li><a href="chap14.html#_problem_dining_philosophers">14.2. Problem: Dining philosophers</a></li>
<li><a href="chap14.html#_concepts_thread_interaction">14.3. Concepts: Thread interaction</a></li>
<li><a href="chap14.html#_syntax_thread_synchronization">14.4. Syntax: Thread synchronization</a></li>
<li><a href="chap14.html#_pitfalls_synchronization_challenges">14.5. Pitfalls: Synchronization challenges</a></li>
<li><a href="chap14.html#_solution_dining_philosophers">14.6. Solution: Dining philosophers</a></li>
<li><a href="chap14.html#_exercises_14">14.7. Exercises</a></li>
</ul>
</li>
<li><a href="chap15.html">15. Constructing Graphical User Interfaces</a>
<ul class="sectlevel2">
<li><a href="chap15.html#_problem_math_tutor">15.1. Problem: Math tutor</a></li>
<li><a href="chap15.html#_concepts_graphical_user_interfaces">15.2. Concepts: Graphical user interfaces</a></li>
<li><a href="chap15.html#_syntax_guis_in_java">15.3. Syntax: GUIs in Java</a></li>
<li><a href="chap15.html#_solution_math_tutor">15.4. Solution: Math tutor</a></li>
<li><a href="chap15.html#_concurrency_guis">15.5. Concurrency: GUIs</a></li>
<li><a href="chap15.html#_summary_6">15.6. Summary</a></li>
<li><a href="chap15.html#_exercises_15">15.7. Exercises</a></li>
</ul>
</li>
<li><a href="chap16.html">16. Testing and Debugging</a>
<ul class="sectlevel2">
<li><a href="chap16.html#_fixing_bugs">16.1. Fixing bugs</a></li>
<li><a href="chap16.html#_concepts_approaches_to_debugging">16.2. Concepts: Approaches to debugging</a></li>
<li><a href="chap16.html#_syntax_java_debugging_tools">16.3. Syntax: Java debugging tools</a></li>
<li><a href="chap16.html#_concurrency_parallel_bugs">16.4. Concurrency: Parallel bugs</a></li>
<li><a href="chap16.html#_finding_and_avoiding_bugs">16.5. Finding and avoiding bugs</a></li>
<li><a href="chap16.html#_concepts_design_implementation_and_testing">16.6. Concepts: Design, implementation, and testing</a></li>
<li><a href="chap16.html#_syntax_java_testing_tools">16.7. Syntax: Java testing tools</a></li>
<li><a href="chap16.html#_concurrency_testing_tools">16.8. Concurrency: Testing tools</a></li>
<li><a href="chap16.html#_examples_testing_a_class">16.9. Examples: Testing a class</a></li>
<li><a href="chap16.html#_exercises_16">16.10. Exercises</a></li>
</ul>
</li>
<li><a href="chap17.html">17. Polymorphism</a>
<ul class="sectlevel2">
<li><a href="chap17.html#_problem_banking_account_with_a_vengeance">17.1. Problem: Banking account with a vengeance</a></li>
<li><a href="chap17.html#_concepts_polymorphism">17.2. Concepts: Polymorphism</a></li>
<li><a href="chap17.html#_syntax_inheritance_tools_in_java">17.3. Syntax: Inheritance tools in Java</a></li>
<li><a href="chap17.html#_solution_banking_account_with_a_vengeance">17.4. Solution: Banking account with a vengeance</a></li>
<li><a href="chap17.html#_concurrency_atomic_libraries">17.5. Concurrency: Atomic libraries</a></li>
<li><a href="chap17.html#_exercises_17">17.6. Exercises</a></li>
</ul>
</li>
<li><a href="chap18.html">18. Dynamic Data Structures</a>
<ul class="sectlevel2">
<li><a href="chap18.html#_problem_infix_conversion">18.1. Problem: Infix conversion</a></li>
<li><a href="chap18.html#_concepts_dynamic_data_structures">18.2. Concepts: Dynamic data structures</a></li>
<li><a href="chap18.html#_syntax_dynamic_arrays_and_linked_lists">18.3. Syntax: Dynamic arrays and linked lists</a></li>
<li><a href="chap18.html#_syntax_abstract_data_types_adt">18.4. Syntax: Abstract data types (ADT)</a></li>
<li><a href="chap18.html#_advanced_generic_data_structures">18.5. Advanced: Generic data structures</a></li>
<li><a href="chap18.html#_solution_infix_conversion">18.6. Solution: Infix conversion</a></li>
<li><a href="chap18.html#_concurrency_linked_lists_and_thread_safety">18.7. Concurrency: Linked lists and thread safety</a></li>
<li><a href="chap18.html#_concurrency_thread_safe_libraries">18.8. Concurrency: Thread-safe libraries</a></li>
<li><a href="chap18.html#_exercises_18">18.9. Exercises</a></li>
</ul>
</li>
<li><a href="chap19.html">19. Recursion</a>
<ul class="sectlevel2">
<li><a href="chap19.html#_problem_maze_of_doom">19.1. Problem: Maze of doom</a></li>
<li><a href="chap19.html#_concepts_recursive_problem_solving">19.2. Concepts: Recursive problem solving</a></li>
<li><a href="chap19.html#_syntax_recursive_methods">19.3. Syntax: Recursive methods</a></li>
<li><a href="chap19.html#_syntax_recursive_data_structures">19.4. Syntax: Recursive data structures</a></li>
<li><a href="chap19.html#_solution_maze_of_doom">19.5. Solution: Maze of doom</a></li>
<li><a href="chap19.html#_concurrency_futures">19.6. Concurrency: Futures</a></li>
<li><a href="chap19.html#_exercises_19">19.7. Exercises</a></li>
</ul>
</li>
<li><a href="chap20.html">20. File I/O</a>
<ul class="sectlevel2">
<li><a href="chap20.html#_problem_a_picture_is_worth_1000_bytes">20.1. Problem: A picture is worth 1,000 bytes</a></li>
<li><a href="chap20.html#_concepts_file_io">20.2. Concepts: File I/O</a></li>
<li><a href="chap20.html#_syntax_file_operations_in_java">20.3. Syntax: File operations in Java</a></li>
<li><a href="chap20.html#_examples_file_examples">20.4. Examples: File examples</a></li>
<li><a href="chap20.html#fileChapterSolution">20.5. Solution: A picture is worth 1,000 bytes</a></li>
<li><a href="chap20.html#_concurrency_file_io">20.6. Concurrency: File I/O</a></li>
<li><a href="chap20.html#_exercises_20">20.7. Exercises</a></li>
</ul>
</li>
<li><a href="chap21.html">21. Network Communication</a>
<ul class="sectlevel2">
<li><a href="chap21.html#_problem_web_server">21.1. Problem: Web server</a></li>
<li><a href="chap21.html#_concepts_tcpip_communication">21.2. Concepts: TCP/IP communication</a></li>
<li><a href="chap21.html#_syntax_networking_in_java">21.3. Syntax: Networking in Java</a></li>
<li><a href="chap21.html#_solution_web_server">21.4. Solution: Web server</a></li>
<li><a href="chap21.html#_concurrency_networking">21.5. Concurrency: Networking</a></li>
<li><a href="chap21.html#_exercises_21">21.6. Exercises</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">





















<div class="sect1">
<h2 id="ch13-concurrency">13. Concurrent Programming</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Time is the substance from which I am made. Time is a river which carries me along, but I am
the river; it is a tiger that devours me, but I am the tiger; it is a fire that consumes me, but I am
the fire.</p>
</div>
</blockquote>
<div class="attribution">
— Jorge Luis Borges
</div>
</div>
<div class="sect2">
<h3 id="_introduction_2">13.1. Introduction</h3>
<div class="paragraph">
<p>So far we’ve focused mostly on writing sequential programs. Sequential execution
means that program statements are executed one at a time in a sequence
determined by program logic and input data. However, more than
one program statement can be executed independently by a multicore
processor. While it’s common for
programmers to write sequential programs, the widespread availability of
multicore processors in a single computer has led to an increase in the
demand for programmers who can write <em>concurrent</em> programs.</p>
</div>
<div class="paragraph">
<p>A concurrent program is one in which several statements can be executed
simultaneously by two or more cores. In this chapter we show how to
write simple concurrent programs in Java that exploit the power of a
multicore computer. We begin with a problem where the fate of the
planet’s in grave danger!</p>
</div>
</div>
<div class="sect2">
<h3 id="_problem_deadly_virus">13.2. Problem: Deadly virus</h3>
<div class="paragraph">
<p>A deadly virus capable of wiping out the world’s population is about to
be released by an evil mastermind. Only he knows the security code that
can stop the countdown. The world is doomed. The single hope for
salvation lies with you and your Java programming skills. Through the
investigations of a top secret, government-funded spy ring, it’s been
revealed that the security code is tied to the number
59,984,005,171,248,659. This large number is the product of two prime
numbers, and the security code is their sum. All you need to do is
factor the number 59,984,005,171,248,659 into its two prime factors and add them.</p>
</div>
<div class="paragraph">
<p>Of course, there’s a catch. The deadly virus is going to be released
soon, so soon that there might not be enough time for your computer to
search through all the numbers one by one. Instead, you must use
concurrency to check more than one number at a time.</p>
</div>
<div class="paragraph">
<p>Does this problem sound contrived? To keep information sent over the
Internet private, many kinds of public key cryptography rely on the
difficulty of factoring large numbers. Although factoring the number in
this problem isn’t difficult, the numbers used for public key
cryptography, typically more than 300 decimal digits long, have resisted
factorization by even the fastest computers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_concepts_splitting_up_work">13.3. Concepts: Splitting up work</h3>
<div class="paragraph">
<p>The deadly virus problem has one large task (factoring a number) to
perform. How should we split up this task so that we can do it more
quickly? Splitting up the work to be done is at the heart of any
concurrent solution to a problem.</p>
</div>
<div class="paragraph">
<p>In a multicore processor, each core is an independent worker. It takes
some care to coordinate these workers. First of all, we still need to
get the right answer. A concurrent solution is worthless if it’s
incorrect, and by reading and writing to the same shared memory, answers
found by one core can corrupt answers found by other cores. Preventing
that problem will be addressed in <a href="chap14.html">Chapter 14</a>.
Once we can guarantee the concurrent solution is correct, we also want to
improve performance. Perhaps we want the task to finish more
quickly. Perhaps we have an interactive system that should continue to
handle user requests even though it’s working on a solution in the
background. Again, if the overhead of coordinating our workers takes
more time than a sequential solution or makes the system less
responsive, it’s not useful.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#sharedThreadVariableExercise">Exercise 13.10</a></p>
</div>
</div>
</div>
<div class="paragraph">
<p>There are two main ways to split up work. The first is called
<em>task decomposition</em>. In this approach, each worker is given a different job
to do. The second is called <em>domain decomposition</em>. In this approach,
the workers do the same job but to different data.</p>
</div>
<div class="paragraph">
<p>It’s possible to use both task and domain decomposition together to
solve the same problem. With both kinds of decomposition, it’s usually
necessary to coordinate the workers so that they can share information.
In the next two subsections, we describe task decomposition and domain
decomposition in greater depth. Then we discuss mapping tasks to threads
of execution and the different memory architectures that can be used for
concurrent programming.</p>
</div>
<div class="sect3">
<h4 id="_task_decomposition">13.3.1. Task decomposition</h4>
<div class="paragraph">
<p>The idea of breaking a task down into smaller subtasks is a natural one.
Imagine you’re planning a dinner party. You need to buy supplies, cook
the dinner, clean your house, and set the table. If four of you were
planning the party, each could perform a separate activity. The
preparations could go much faster than if a single person was doing the
work, but coordination is still important. Perhaps the person cooking
the dinner couldn’t finish until certain supplies were bought.</p>
</div>
<div class="paragraph">
<p>Task decomposition is often easier than domain decomposition because
many tasks have natural divisions. Unfortunately, it’s not always an
effective way to use multiple cores on a computer. If one task finishes
long before the others, a core might sit idle.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#minimumTimeForTasksExercise">Exercise 13.9</a></p>
</div>
</div>
</div>
<div class="paragraph">
<p>The next two examples give simple illustrations of the process of
splitting a task into smaller subtasks in the context of multicore
programming.</p>
</div>
<div id="videoGameTasksExample" class="exampleblock">
<div class="title">Example 13.1 Video game tasks</div>
<div class="content">
<div class="paragraph">
<p>Consider a simple video game that consists of the following tasks.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start game</p>
</li>
<li>
<p>Process move</p>
</li>
<li>
<p>Update score</p>
</li>
<li>
<p>Repaint screen</p>
</li>
<li>
<p>End game</p>
</li>
</ol>
</div>
<div id="figure-video_game_tasks" class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/video-game-tasks.svg" alt="video game tasks" width="75%">
</div>
<div class="title">Figure 13.1 Execution of tasks in a video game. (a) Sequential execution on a single core. (b)&nbsp;Concurrent execution on two cores. Arrows show the flow of execution and data transfer.</div>
</div>
<div class="paragraph">
<p>Suppose that tasks B and D are independent and can be executed
concurrently if two cores are available. Task D continually updates the
screen with the old data until task C updates the information.</p>
</div>
<div class="paragraph">
<p><a href="chap13.html#figure-video_game_tasks">Figure 13.1</a>(a) and (b) show how the tasks in this
video game can be sequenced, respectively, on a single core or on two
cores. All tasks are executed sequentially on a single-core processor.
In a dual-core processor tasks B and C can execute on one core while
task D is executing concurrently on another. Note from the figure that
task C sends the score and any other data to task D which is
continuously updating the screen. Having two cores can allow a faster
refresh of the display since the processor doesn’t have to wait for tasks
B or C to complete.</p>
</div>
</div>
</div>
<div id="mathExpressionTasksExample" class="exampleblock">
<div class="title">Example 13.2 Math expression tasks</div>
<div class="content">
<div class="paragraph">
<p>Suppose we need to evaluate the mathematical expression
2<em>Kate</em><sup>-⁠<em>at</em>²</sup> with parameters <em>a</em> and <em>K</em> at a given value of
<em>t</em>.  We can divide the expression into two terms:
2<em>Kat</em> and <em>e</em><sup>-⁠<em>at</em>²</sup>.
Each of these terms can be assigned to a different task for evaluation.
On a dual-core processor, these two tasks can be executed on separate
cores and the results from each combined to find the value of the
expression for the main task.</p>
</div>
<div id="figure-math_evaluation" class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/mathematical-expression-evaluation.svg" alt="mathematical expression evaluation" width="75%">
</div>
<div class="title">Figure 13.2 Evaluation of a mathematical expression (a) sequentially on a single core and (b) concurrently on two cores. Arrows show the flow of execution and data transfer. Bold typeface indicates the operation being performed.</div>
</div>
<div class="paragraph">
<p><a href="chap13.html#figure-math_evaluation">Figure 13.2</a> shows how this expression can be
evaluated on single core and dual-core processors. Sometimes, using
multiple cores to evaluate an expression like this will take less time
than a single core. However, there’s no guarantee that using multiple
cores will always be faster since tasks take time to set up and to
communicate with each other.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#mathExpressionTimingExercise">Exercise 13.4</a><br>
<a href="chap13.html#quad-coreExercise">Exercise 13.5</a></p>
</div>
</div>
</div>
<div class="paragraph">
<p>These examples illustrate how a task can be divided into two or more
subtasks executed by different cores of a processor. We use a dual-core
processor for our examples, but the same ideas can be expanded to a
larger number of cores.</p>
</div>
</div>
<div class="sect3">
<h4 id="_domain_decomposition">13.3.2. Domain decomposition</h4>
<div class="paragraph">
<p>In a computer program, every task performs operations on data. This data
is called the <em>domain</em> of that task. In domain decomposition, the data
is divided into smaller chunks where each chunk is assigned to a
different core, instead of dividing a task into subtasks. Thus, each core
executes the same task but on different data.</p>
</div>
<div class="paragraph">
<p>In the example of the dinner party, we could have used domain
decomposition instead of (or in addition to) task decomposition. If you
want to cook a massive batch of mashed potatoes, you could peel 24
potatoes yourself. However, if there are four people (and each has
a potato peeler), each person would only need to peel 6 potatoes.</p>
</div>
<div class="paragraph">
<p>The strategy of domain decomposition is very useful and is one of the
major focuses of concurrency in this book. Problems in modern computing
often use massive data, comprising millions of values or thousands of
database records. Writing programs that can chop up data so that
multiple cores can process smaller sections of it can greatly speed up
the time it takes to finish computation.</p>
</div>
<div class="paragraph">
<p>In some ways, domain decomposition can be more difficult than task decomposition. The
data must be divided evenly and fairly. Once each section of data has
been processed, the results must be combined. Companies like Google that
process massive amounts of information have developed terminology to
describe this process. Dividing up the data and assigning it to workers
is called the <em>map</em> step. Combining the partial answers into the final
answer is called the <em>reduce</em> step.</p>
</div>
<div class="paragraph">
<p>We illustrate the domain decomposition strategy in the next two
examples.</p>
</div>
<div id="arraySummationPreviewExample" class="exampleblock">
<div class="title">Example 13.3 Array summation preview</div>
<div class="content">
<div class="paragraph">
<p>Suppose we want to apply function <em>f</em> to each element
of an array <em>a</em> and sum the results. Mathematically, we want
to compute the following sum.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/oneCoreSum.svg" alt="oneCoreSum" width="15%">
</div>
</div>
<div class="paragraph">
<p>In this formula, <em>a</em><sub><em>i</em></sub> is the <em>i</em><sup>th</sup> element
of array <em>a</em>. Let’s assume we have a dual-core processor available to
compute the sum. We split up the array so that each core performs the
task on half of the array. Let <em>S</em><sub>1</sub> and <em>S</em><sub>2</sub>
denote the sums computed by core 1 and core 2, respectively.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/twoCoreSum.svg" alt="twoCoreSum" width="50%">
</div>
</div>
<div class="paragraph">
<p>Assuming that <em>N</em> is even, both cores process exactly the
same amount of data. For odd <em>N</em>, one of the cores processes
one more data item than the other.</p>
</div>
<div id="figure-array_decomposition" class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/arrayDecomposition.svg" alt="arrayDecomposition" width="60%">
</div>
<div class="title">Figure 13.3 Computing the sum of a function of each element of an array.</div>
</div>
<div class="paragraph">
<p>After <em>S</em><sub>1</sub> and <em>S</em><sub>2</sub> have been computed, one of
the cores can add these two numbers together to get <em>S</em>.
This strategy is illustrated in <a href="chap13.html#figure-array_decomposition">Figure 13.3</a>.
After the two cores have completed their work on each half of the array,
the individual sums are added together to produce the final sum.</p>
</div>
</div>
</div>
<div id="matrixMultiplicationPreviewExample" class="exampleblock">
<div class="title">Example 13.4 Matrix multiplication preview</div>
<div class="content">
<div class="paragraph">
<p>The need to multiply matrices arises in many mathematical, scientific,
and engineering applications. Suppose we’re asked to write a program to
multiply two square matrices <em>A</em> and <em>B</em>, which
are both <em>n</em> × <em>n</em> matrices. The product matrix
<em>C</em> will also be <em>n</em> × <em>n</em>. A sequential
program will compute each element of matrix <em>C</em> one at a
time. However, a concurrent program can compute more than one element of
<em>C</em> simultaneously using multiple cores.</p>
</div>
<div id="figure-matrix_decomposition" class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/matrixDecomposition.svg" alt="matrixDecomposition" width="75%">
</div>
<div class="title">Figure 13.4 Data decomposition to multiply two 4 × 4 matrices. The two cores perform the same multiplication tasks but on different data from matrix <em>A</em>. The two cores compute the top two and bottom two rows of <em>C</em>, respectively.</div>
</div>
<div class="paragraph">
<p>In this problem, the task is to multiply matrices <em>A</em> and
<em>B</em>. Through domain decomposition, we can replicate this
task on each core. As shown in <a href="chap13.html#figure-matrix_decomposition">Figure 13.4</a>,
each core computes only a portion of <em>C</em>. For example, if
<em>A</em> and <em>B</em> are 4 × 4
matrices, we can ask one core to compute the product of the first two
rows of <em>A</em> with all four columns of <em>B</em> to
generate the first two rows of <em>C</em>. The second core computes
the remaining two rows of <em>C</em>. Both cores can access
matrices <em>A</em> and <em>B</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tasks_and_threads">13.3.3. Tasks and threads</h4>
<div class="paragraph">
<p>It’s the programmer’s responsibility to divide his or her solution into
a number of tasks and subtasks which will run on one or more cores on a
processor. In previous sections, we described concurrent programs as if
specific tasks could be assigned specific cores, but Java doesn’t
provide a direct way to do so.</p>
</div>
<div class="paragraph">
<p>Instead, a Java programmer must group together a set of tasks and
subtasks into a <em>thread</em>. A thread is very much like a sequential
program. In fact, all sequential programs are made up of a single thread.
A thread is a segment of executing code that runs through its instructions step
by step. Each thread can run independently. If you have a single core
processor, only one thread can run at a time, and all the threads will
take turns. If you have a multicore processor, as many threads as there
are cores can execute at the same time. You can’t pick which core a
given thread will run on. In most cases, you won’t even be able to
tell which core a given thread is using.</p>
</div>
<div class="paragraph">
<p>It takes care to package up the right set of tasks into a single thread
of execution. Recall the previous examples of concurrent programming in
this chapter.</p>
</div>
<div class="paragraph">
<p>Consider dividing the tasks in <a href="chap13.html#videoGameTasksExample">Example 13.1</a> into
two threads. Tasks B and C in can be packaged into thread 1, and task D
can be packaged into thread 2. This division is shown in
<a href="chap13.html#figure-tasks_in_threads">Figure 13.5</a>(a).</p>
</div>
<div class="paragraph">
<p>Tasks to evaluate different subexpressions in <a href="chap13.html#mathExpressionTasksExample">Example 13.2</a> can also be divided into two threads as shown in
<a href="chap13.html#figure-tasks_in_threads">Figure 13.5</a>(b). In many problems there are
several reasonable ways of dividing a set of subtasks into threads.</p>
</div>
<div id="figure-tasks_in_threads" class="imageblock">
<div class="content">
<img src="chapters/13-concurrency/images/task-thread-packaging.svg" alt="task thread packaging" width="100%">
</div>
<div class="title">Figure 13.5 (a)&nbsp;Tasks in a video game shown packaged into two threads. (b) Tasks to evaluate a mathematical expression shown packaged into two threads. Each thread may or may not run on the same core as the other.</div>
</div>
<div class="paragraph">
<p>Note that these figures look exactly like the earlier figures, except
that the tasks are grouped as threads instead of cores. This grouping
matches reality better, since we can control how the tasks are packaged
into threads but not how they are assigned to cores.</p>
</div>
<div class="paragraph">
<p>In both examples, we have two threads. It’s possible that some other
thread started these threads running. Every Java program, concurrent or
sequential, starts with one thread. We’ll refer to this thread as the
<em>main</em> thread since it contains the <code>main()</code> method.</p>
</div>
<div class="paragraph">
<p><a href="chap13.html#arraySummationPreviewExample">Example 13.3</a> and <a href="chap13.html#matrixMultiplicationPreviewExample">Example 13.4</a> use multiple identical tasks,
but these tasks operate on different data. In <a href="chap13.html#arraySummationPreviewExample">Example 13.3</a>,
the two tasks can be assigned to two threads that
operate on different portions of the input array. The task of summing
the results from the two threads can either be a separate thread or a
subtask included in one of the other threads. In
<a href="chap13.html#matrixMultiplicationPreviewExample">Example 13.4</a>, the two tasks can
again be assigned to two distinct threads that operate on different
parts of the input matrix <em>A</em> to generate the corresponding
portions of the output matrix <em>C</em>.</p>
</div>
<div class="paragraph">
<p>There can be many ways to package tasks into threads. There can also be
many ways to decompose data into smaller chunks. The best ways to
perform these subdivisions of tasks or data depend on the problem at
hand and the processor architecture on which the program will be
executed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_memory_architectures_and_concurrency">13.3.4. Memory architectures and concurrency</h4>
<div class="paragraph">
<p>The two most important paradigms for concurrent programming are message
passing and shared memory systems. Each paradigm handles communication
between the various units of code running in parallel in a different
way. Message passing systems such as MPI approach this problem
by sending messages between otherwise independent units of code called
processes. A process which is executing a task may have to wait until it
receives a message from another process before it knows how to proceed.
Messages can be sent from a single process to one other or
broadcast to many. Message passing systems are especially useful when
the processors doing the work do not share memory.</p>
</div>
<div class="paragraph">
<p>In contrast, the built-in system for concurrency in Java uses the shared
memory paradigm. In Java, a programmer
can create a number of threads which share the same memory space. Each
thread is an object which can perform work. We described threads as a
way to package up a group of tasks, and processes are another. People
use the term <em>processes</em> to describe units of code executing with
separate memory and <em>threads</em> to describe units of code executing
with shared memory.</p>
</div>
<div class="paragraph">
<p>When you first learned to program, one of the biggest challenges was
probably learning to solve a problem step by step. Each line of the
program had to be executed one at a time, logically and
deterministically. Human beings don’t naturally think that way. We tend
to jump from one thing to another, making inferences and guesses,
thinking about two unrelated things at once, and so on. As you know
now, it’s only possible to write and debug programs because of the
methodical way they work.</p>
</div>
<div class="paragraph">
<p>You can imagine the execution of a program as an arrow that points to
one line of code, then the next, then the next, and so on. We can think
of the movement of this arrow as the thread of execution of the program.
The code does the actual work, but the arrow keeps track of where
execution in the program currently is. The code can move the arrow
forward, it can do basic arithmetic, it can decide between choices with
<code>if</code> statements, it can do things repeatedly with loops, it can jump
into a method and then come back. A single thread of execution can do
all of these things, but its arrow can’t be two places at once. It can’t
be dividing two numbers in one part of the program and evaluating an
<code>if</code> statement in another. However, there’s a way to split this thread
of execution so that two or more threads are executing different parts
of the program, and the next section will show you how this is done in
Java.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_syntax_threads_in_java">13.4. Syntax: Threads in Java</h3>
<div class="sect3">
<h4 id="_the_thread_class">13.4.1. The <code>Thread</code> class</h4>
<div class="paragraph">
<p>Java, like many programming languages, includes the necessary features
to package tasks and subtasks into threads. The <code>Thread</code> class and its
subclasses provide the tools for creating and managing threads. For
example, the following class definition allows objects of type
<code>ThreadedTask</code> to be created. Such an object can be executed as a
separate thread.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadedTask</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="c1">// Add constructor and body of class</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The constructor is written just like any other constructor, but there’s
a special <code>run()</code> method in <code>Thread</code> that can be overridden by any of
its subclasses. This method is the starting point for the thread of
execution associated with an instance of the class. Most Java
applications begin with a single main thread which starts in a <code>main()</code>
method. Additional threads must start somewhere, and that place is the
<code>run()</code> method. A Java application will continue to run as long as at
least one thread is active. The following example shows two threads,
each evaluating a separate subexpression as in <a href="chap13.html#figure-tasks_in_threads">Figure 13.5</a>(b).</p>
</div>
<div id="threadSamplesExample" class="exampleblock">
<div class="title">Example 13.5 Thread samples</div>
<div class="content">
<div class="paragraph">
<p>We’ll create <code>Thread1</code> and <code>Thread2</code> classes. The threads of execution
created by instances of these classes compute, respectively, the two
subexpressions in <a href="chap13.html#figure-tasks_in_threads">Figure 13.5</a>(b) and save the
computed values.</p>
</div>
<div id="Thread1Program" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Thread1</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="no">K</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="n">value</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">Thread1</span><span class="o">(</span><span class="kt">double</span> <span class="no">K</span><span class="o">,</span> <span class="kt">double</span> <span class="n">a</span><span class="o">,</span> <span class="kt">double</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">K</span> <span class="o">=</span> <span class="no">K</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
    <span class="o">}</span> 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="no">K</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div id="Thread2Program" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Thread2</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">a</span><span class="o">,</span> <span class="n">t</span><span class="o">,</span> <span class="n">value</span><span class="o">;</span>
    
    <span class="kd">public</span>  <span class="nf">Thread2</span><span class="o">(</span><span class="kt">double</span> <span class="n">a</span><span class="o">,</span> <span class="kt">double</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> <span class="n">value</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">exp</span><span class="o">(-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="o">);</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>run()</code> method in each thread above computes a subexpression and
saves its value. We show how these threads can be executed to solve the
math expression problem in <a href="chap13.html#mathExpressionThreadsExample">Example 13.6</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_thread_object">13.4.2. Creating a thread object</h4>
<div class="paragraph">
<p>Creating an object from a subclass of <code>Thread</code> is the same as creating
any other object in Java. For example, we can instantiate the <code>Thread1</code>
class above to create an object called <code>thread1</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Thread1</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread1</span><span class="o">(</span><span class="mf">15.1</span><span class="o">,</span> <span class="mf">2.8</span><span class="o">,</span> <span class="mf">7.53</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>new</code> keyword to invoke the constructor creates a <code>Thread1</code>
object, but it doesn’t start executing it as a new thread. As with all
other classes, the constructor initializes the values inside of the new
object. A subclass of <code>Thread</code> can have many different constructors with
whatever parameters its designer thinks appropriate.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_a_thread">13.4.3. Starting a thread</h4>
<div class="paragraph">
<p>To start the thread object executing, its <code>start()</code> method must be
called. For example, the <code>thread1</code> object created above can be started
as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once started, a thread executes independently.  Calling the <code>start()</code>
method automatically calls the object’s <code>run()</code> method behind the
scenes. When a thread needs to share data with another thread, it
might have to wait.</p>
</div>
</div>
<div class="sect3">
<h4 id="_waiting_for_a_thread">13.4.4. Waiting for a thread</h4>
<div class="paragraph">
<p>Often some thread, main or otherwise, needs to wait for another thread
before proceeding further with its execution. The <code>join()</code> method is
used to wait for a thread to finish executing. For example, whichever
thread executes the following code will wait for <code>thread1</code> to complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">thread1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Calling <code>join()</code> is a <em>blocking</em> call, meaning that the code calling
this method will wait until it returns. Since it can throw a a checked
<code>InterruptedException</code> while the code’s waiting, the <code>join()</code> method
is generally used within a <code>try</code>-<code>catch</code> block. We can add a
<code>try</code>-<code>catch</code> block to the <code>thread1</code> example so that we can recover from
being interrupted while waiting for <code>thread1</code> to finish.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="k">try</span> <span class="o">{</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Waiting for thread 1..."</span><span class="o">);</span>
	<span class="n">thread1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Thread 1 finished!"</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Thread 1 didn't finish!"</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the <code>InterruptedException</code> is thrown because the main thread
was interrupted while waiting for <code>thread1</code> to finish. If the <code>join()</code>
call returns, then <code>thread1</code> must have finished, and we inform the user.
If an <code>InterruptedException</code> is thrown, some outside thread must have
interrupted the main thread, forcing it to stop waiting for <code>thread1</code>.</p>
</div>
<div class="paragraph">
<p>In earlier versions of Java, there was a <code>stop()</code> method which would
stop an executing thread. Although this method still exists, it’s been
deprecated and shouldn’t be used because it can make a program behave
in an unexpected way.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#threadMethodsExercise">Exercise 13.1</a></p>
</div>
</div>
</div>
<div id="mathExpressionThreadsExample" class="exampleblock">
<div class="title">Example 13.6 Math expression threads</div>
<div class="content">
<div class="paragraph">
<p>Now that we have the syntax to start threads and wait for them to
finish, we can use the threads defined in <a href="chap13.html#threadSamplesExample">Example 13.5</a> with a
main thread to make our first complete concurrent
program. The main thread in class <code>MathExpression</code> creates and starts
the worker threads <code>thread1</code> and <code>thread2</code> and waits for their
completion. When the two threads complete their execution, we can ask
each for its computed value. The main thread then prints the product of
these values, which is the result of the expression we want to evaluate.</p>
</div>
<div id="MathExpressionProgram" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MathExpression</span> <span class="o">{</span> 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span> <span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="no">K</span> <span class="o">=</span> <span class="mi">120</span><span class="o">,</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">1.2</span><span class="o">,</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="nc">Thread1</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread1</span><span class="o">(</span><span class="no">K</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
        <span class="nc">Thread2</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread2</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// Start thread1</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// Start thread2</span>
        <span class="k">try</span> <span class="o">{</span> <span class="c1">// Wait for both threads to complete</span>
            <span class="n">thread1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
            <span class="n">thread2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Value of expression: "</span> <span class="o">+</span>
                    <span class="n">thread1</span><span class="o">.</span><span class="na">getValue</span><span class="o">()*</span><span class="n">thread2</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"A thread didn't finish!"</span><span class="o">);</span>
        <span class="o">}</span>        
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to make it absolutely clear when threads are created, start
executing, and finish. These details are crucial for the finer points of
concurrent Java programming. In <a href="chap13.html#figure-tasks_in_threads">Figure 13.5</a>, it
appears as if execution of the concurrent math expression evaluation
begins with Thread 1 which spawns Thread 2. Although that figure
explains the basics of task decomposition well, the details are messier
for real Java code.</p>
</div>
<div class="paragraph">
<p>In the code above, execution starts with the <code>main()</code> method in
<code>MathExpression</code>. It creates <code>Thread1</code> and <code>Thread2</code> objects and waits
for them to finish. Then, it reads the values from the objects after
they’ve stopped executing. We could have put the <code>main()</code> method in
the <code>Thread1</code> class, omitting the <code>MathExpression</code> class entirely. Doing
so would make the execution match <a href="chap13.html#figure-tasks_in_threads">Figure 13.5</a>
more closely, but it would make the two <code>Thread</code> subclasses less
symmetrical: The main thread and <code>thread1</code> would both independently
execute code inside the <code>Thread1</code> class while only <code>thread2</code> would
execute code inside the <code>Thread2</code> class.</p>
</div>
<div id="figure-thread_execution" class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/thread-lifecycle.svg" alt="thread lifecycle" width="75%">
</div>
<div class="title">Figure 13.6 Creation, starting, and joining of threads in <code>MathExpression</code>, <code>Thread1</code>, and <code>Thread2</code>.</div>
</div>
<div class="paragraph">
<p><a href="chap13.html#figure-thread_execution">Figure 13.6</a> shows the execution of <code>thread1</code> and
<code>thread2</code> and the main thread. Note that the JVM implicitly creates and starts
the main thread which explicitly creates and starts <code>thread1</code> and <code>thread2</code>.
Even after the threads associated with <code>thread1</code> and <code>thread2</code> have stopped running,
the objects associated with them continue to exist. Their methods and fields can still be
accessed.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_runnable_interface">13.4.5. The <code>Runnable</code> interface</h4>
<div class="paragraph">
<p>Although it’s possible to create Java threads by inheriting from the
<code>Thread</code> class directly, the Java API allows the programmer to use an
interface instead.</p>
</div>
<div class="paragraph">
<p>As an example, the <code>Summer</code> class takes an array of <code>int</code> values and
sums them up within a given range. If multiple instances of this class
are executed as separate threads, each one can sum up different parts of
an array.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Summer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">array</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">lower</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">upper</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">Summer</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">array</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lower</span><span class="o">,</span> <span class="kt">int</span> <span class="n">upper</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lower</span> <span class="o">=</span> <span class="n">lower</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">upper</span> <span class="o">=</span> <span class="n">upper</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lower</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">sum</span> <span class="o">+=</span> <span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSum</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">sum</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This class is very similar to one that inherits from <code>Thread</code>. Imagine
for a moment that the code following <code>Summer</code> is <code>extends Thread</code>
instead of <code>implements Runnable</code>. The key thing a class derived from
<code>Thread</code> needs is an overridden <code>run()</code> method. Since only the <code>run()</code>
method is important, the designers of Java provided a way to create a
thread using the <code>Runnable</code> interface. To implement this interface, only
a <code>public void run()</code> method is required.</p>
</div>
<div class="paragraph">
<p>When creating a new thread, there are some differences in syntax between
the two styles. The familiar way of creating and running a thread from a
<code>Thread</code> subclass is as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Summer</span> <span class="n">summer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Summer</span><span class="o">(</span><span class="n">array</span><span class="o">,</span> <span class="n">lower</span><span class="o">,</span> <span class="n">upper</span><span class="o">);</span>
<span class="n">summer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>Summer</code> doesn’t inherit from <code>Thread</code>, it doesn’t have a
<code>start()</code> method, and this code won’t compile. When a class only
implements <code>Runnable</code>, it’s still necessary to create a <code>Thread</code> object
and call its <code>start()</code> method. Thus, an extra step is needed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">Summer</span> <span class="n">summer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Summer</span><span class="o">(</span><span class="n">array</span><span class="o">,</span> <span class="n">lower</span><span class="o">,</span> <span class="n">upper</span><span class="o">);</span>
<span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">summer</span><span class="o">);</span>
<span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This alternate way of implementing the <code>Runnable</code> interface seems more
cumbersome than inheriting directly from <code>Thread</code>, since you have to
instantiate a separate <code>Thread</code> object. However, most developers prefer
to design classes that implement <code>Runnable</code> instead of inheriting from
<code>Thread</code>. Why? Java only allows for single inheritance. If your class
implements <code>Runnable</code>, it’s free to inherit from another parent class
with features you might want.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#extendingThreadExercise">Exercise 13.2</a></p>
</div>
</div>
</div>
<div id="arrayOfThreadsExample" class="exampleblock">
<div class="title">Example 13.7 Array of threads</div>
<div class="content">
<div class="paragraph">
<p>In domain decomposition, we often need to create multiple threads, all
from the same class. As an example, consider the following thread
declaration.</p>
</div>
<div id="NumberedThreadProgram" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NumberedThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">NumberedThread</span><span class="o">(</span><span class="kt">int</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span> <span class="n">value</span> <span class="o">=</span> <span class="n">input</span><span class="o">;</span> <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Thread "</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, suppose we want to create 10 thread objects of type
<code>NumberedThread</code>, start them, and then wait for them to complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">NumberedThread</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NumberedThread</span><span class="o">[</span><span class="mi">10</span><span class="o">];</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NumberedThread</span><span class="o">(</span><span class="n">i</span><span class="o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="o">}</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
        <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="o">}</span>
<span class="k">catch</span><span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"A thread didn't finish!"</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First, we declare an array to hold references to <code>NumberedThread</code>
objects. Like any other type, we can make an array to hold objects that
inherit from <code>Thread</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The first line of the <code>for</code> loop instantiates a
new <code>NumberedThread</code> object, invoking the constructor which stores the
current iteration of the loop into the <code>value</code> field. The reference to
each <code>NumberedThread</code> object is stored in the array. Remember that the
constructor does <strong>not</strong> start a new thread running.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The second line of the <code>for</code> loop does that.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We’re also interested in when the threads stop. Calling the <code>join()</code>
method forces the main thread to wait for each thread to finish.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The entire second <code>for</code> loop is nested inside of a <code>try</code> block. If the
main thread is interrupted while waiting for any of the threads to
finish, an <code>InterruptedException</code> will be caught. As before, we warn the
user that a thread didn’t finish. For production-quality code, the
<code>catch</code> block should handle the exception in such a way that the thread
can recover and do useful work even though it didn’t get what it was
waiting for.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_examples_concurrency_and_speedup">13.5. Examples: Concurrency and speedup</h3>
<div class="paragraph">
<p>Speedup is one of the strongest motivations for writing concurrent
programs. To understand speedup, let’s assume we have a problem to
solve. We write two programs to solve this problem, one that’s
sequential and another that’s concurrent and, hence, able to exploit
multiple cores. Let <em>t</em><sub><em>s</em></sub> be the average time to execute
the sequential program and <em>t</em><sub><em>c</em></sub> the average time to execute
the concurrent program. So that the comparison is
meaningful, assume that both programs are executed on the same computer.
The speedup obtained from concurrent programming is defined as <em>t</em><sub><em>s</em></sub>/<em>t</em><sub><em>c</em></sub>.</p>
</div>
<div class="paragraph">
<p>Speedup measures how much faster the concurrent program executes
relative to the sequential program. Ideally, we expect
<em>t</em><sub><em>c</em></sub> &lt; <em>t</em><sub><em>s</em></sub>, making the speedup greater than 1. However,
simply writing a concurrent program doesn’t guarantee that it’s faster
than the sequential version.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#speedupExercise">Exercise 13.6</a><br>
<a href="chap13.html#AmdahlLawExercise">Exercise 13.8</a></p>
</div>
</div>
</div>
<div class="paragraph">
<p>To determine speedup, we need to measure <em>t</em><sub><em>s</em></sub> and
<em>t</em><sub><em>c</em></sub>. Time in a Java program can easily be measured with
the following two static methods in the <code>System</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">currentTimeMillis</span><span class="o">()</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">nanoTime</span><span class="o">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first of these methods returns the current time in milliseconds
(ms). A <em>millisecond</em> is 0.001 seconds. This method gives the difference
between the current time on your computer’s clock and midnight of
January&nbsp;1,&nbsp;1970 Coordinated Universal Time (UTC). This point in time is
used for many timing features on many computer platforms and is called
the <em>Unix epoch</em>. The other method returns the current time in
nanoseconds (ns). A <em>nanosecond</em> is 0.000000001 or 10<sup>-9</sup> seconds. This method also
gives the difference between the current time and some fixed time, which
is system dependent and not necessarily the Unix epoch. The
<code>System.nanoTime()</code> method can be used when you want timing precision
finer than milliseconds; however, the level of accuracy it returns is
again system dependent. The next example show how to use these methods
to measure execution time.</p>
</div>
<div class="exampleblock">
<div class="title">Example 13.8 Measuring execution time</div>
<div class="content">
<div class="paragraph">
<p>Suppose we want to measure the execution time of a piece of Java code.
For convenience, we can assume this code is contained in the <code>work()</code>
method. The following code snippet measures the time to execute
<code>work()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
<span class="n">work</span><span class="o">();</span>
<span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Elapsed time: "</span> <span class="o">+</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">)</span> <span class="o">+</span> <span class="s">" ms"</span><span class="o">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will give the execution time for <code>work()</code> measured in
milliseconds. To get the execution time in nanoseconds, use the
<code>System.nanoTime()</code> method instead.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#executionVariationExercise">Exercise 13.15</a><br>
<a href="chap13.html#threadOverheadExercise">Exercise 13.16</a></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Now that we have the tools to measure execution time, we can measure
speedup. The next few examples show the speedup (or lack of it) that we
can achieve using a concurrent solution to a few simple problems.</p>
</div>
<div class="exampleblock">
<div class="title">Example 13.9 Math expression speedup</div>
<div class="content">
<div class="paragraph">
<p>Recall the concurrent program in <a href="chap13.html#mathExpressionThreadsExample">Example 13.6</a> to evaluate a simple mathematical expression. This program
uses two threads. We executed this multi-threaded program on an iMac
computer with an Intel Core 2 Duo running at 2.16 Ghz. The execution
time was measured at 1,660,000 nanoseconds. We also wrote a simple
sequential program to evaluate the same expression. It took 4,100
nanoseconds to execute this program on the same computer. Plugging in
these values for <em>t</em><sub><em>c</em></sub> and <em>t</em><sub><em>s</em></sub>, we can find
the speedup.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/speedup.svg" alt="speedup" width="45%">
</div>
</div>
<div class="paragraph">
<p>This speedup is much less than 1. Although this result might be surprising,
the concurrent program with two threads executes slower than the
sequential program. In this example, the cost of creating, running, and
joining threads outweighs the benefits of concurrent calculation on two
cores.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#speedupLimitationsExercise">Exercise 13.7</a></p>
</div>
</div>
</div>
<div id="arraySummationExample" class="exampleblock">
<div class="title">Example 13.10 Array summation</div>
<div class="content">
<div class="paragraph">
<p>In <a href="chap13.html#arraySummationPreviewExample">Example 13.3</a>, we introduced the
problem of applying a function to every value in an array and then
summing the results. Let’s say that we want to apply the sine function
to each value. To solve this problem concurrently, we partition the
array evenly among a number of threads, using the domain decomposition
strategy. Each thread finds the sum of the sines of the values in its
part of the array. One factor that determines whether or not we achieve
speedup is the complexity of the function, in this case sine, that we
apply. Although we may achieve speedup with sine, a simpler function
such as doubling the value might not create enough work to justify the
overhead of using threads.</p>
</div>
<div class="paragraph">
<p>We create class <code>SumThread</code> whose <code>run()</code> method sums the sines of those
elements of the array in its assigned partition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SumThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">lower</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">upper</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">double</span><span class="o">[]</span> <span class="n">array</span><span class="o">;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">SIZE</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">;</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">THREADS</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">SumThread</span><span class="o">(</span><span class="kt">double</span><span class="o">[]</span> <span class="n">array</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lower</span><span class="o">,</span> <span class="kt">int</span> <span class="n">upper</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="4"></i><b>(4)</b>
		<span class="k">this</span><span class="o">.</span><span class="na">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lower</span> <span class="o">=</span> <span class="n">lower</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">upper</span> <span class="o">=</span> <span class="n">upper</span><span class="o">;</span>     
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First, we set up all the fields that the class will need.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Note that every <code>SumThread</code> object will have its own reference to the array of data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We fix the
array size at 1,000,000 and the number of threads at 8, but these values
could easily be changed or read as input instead.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In its constructor, a <code>SumThread</code> takes a reference to the array of data
and the lower and upper bounds of its partition. Like most
ranges we discuss, the lower bound is inclusive though the upper bound
is exclusive.</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lower</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">sum</span> <span class="o">+=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">sin</span><span class="o">(</span><span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">double</span> <span class="nf">getSum</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">sum</span><span class="o">;</span> <span class="o">}</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In the <code>for</code> loop of the <code>run()</code> method, the <code>SumThread</code> finds the sine
of each number in its array partition and adds that value to its running
sum.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>getSum()</code> method is an accessor that allows the running sum to
be retrieved.</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>  
        <span class="kt">double</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="o">[</span><span class="no">SIZE</span><span class="o">];</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="nc">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>  
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">SIZE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="n">data</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextDouble</span><span class="o">();</span>  
        <span class="nc">SumThread</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SumThread</span><span class="o">[</span><span class="no">THREADS</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">quotient</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span> <span class="o">/</span> <span class="no">THREADS</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">length</span> <span class="o">%</span> <span class="no">THREADS</span><span class="o">;</span>          
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">THREADS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">work</span> <span class="o">=</span> <span class="n">quotient</span><span class="o">;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="o">)</span>
                <span class="n">work</span><span class="o">++;</span>
            <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SumThread</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">start</span><span class="o">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">work</span><span class="o">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span> <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">work</span><span class="o">;</span>
        <span class="o">}</span>   </code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>main()</code> method begins by instantiating the array.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It fills it with random values.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then, each thread is created by passing in a reference to the array and
lower and upper bounds that mark the thread’s partition of the array. If the
process using the array length and the number of threads to determine
upper and lower bounds doesn’t make sense, refer to
<a href="chap6.html#_concurrency_arrays">Section 6.11</a> which describes the fair division of work
to threads. If the length of the array is not divisible by the number of
threads, simple division isn’t enough.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>After each thread is created, its <code>start()</code> method is called.</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">        <span class="kt">double</span> <span class="n">sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="k">try</span> <span class="o">{</span> 
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">THREADS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span> <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="n">sum</span> <span class="o">+=</span> <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getSum</span><span class="o">();</span> <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Sum: "</span> <span class="o">+</span> <span class="n">threads</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">getSum</span><span class="o">());</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="o">}</span>
    <span class="o">}</span>   
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Once the threads have started working, the main thread creates its own
running total.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It iterates through each thread waiting for it to
complete.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When each thread is done, its value is added to
the running total.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally, the sum is printed out.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If the main thread is interrupted while waiting for a
thread to complete, the stack trace is printed.</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#parallelAudioProcessingExercise">Exercise 13.12</a><br>
<a href="chap13.html#arraySummingSpeedupExercise">Exercise 13.19</a><br>
<a href="chap13.html#treeSummationExercise">Exercise 13.20</a></p>
</div>
</div>
</div>
<div id="matrixMultiplicationExample" class="exampleblock">
<div class="title">Example 13.11 Matrix multiplication</div>
<div class="content">
<div class="paragraph">
<p>In <a href="chap13.html#matrixMultiplicationPreviewExample">Example 13.4</a>, we discussed the
importance of matrix operations in many applications. Now that we know
the necessary Java syntax, we can write a concurrent program to multiply
two square matrices <em>A</em> and <em>B</em> and compute the
resultant matrix <em>C</em>. If these matrices have <em>n</em>
rows and <em>n</em> columns, the value at the <em>i</em><sup>th</sup>
row and <em>j</em><sup>th</sup> column of <em>C</em> is</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/matrixValue.svg" alt="matrixValue" width="55%">
</div>
</div>
<div class="paragraph">
<p>In Java, it’s natural for us to store matrices as 2-dimensional arrays.
To do this multiplication sequentially, the simplest approach uses three
nested <code>for</code> loops. The code below is a direct translation of the
mathematical notation, but we do have to be careful about bookkeeping.
Note that mathematical notation often uses uppercase letters to
represent matrices though the Java convention is to start all variable
names with lowercase letters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">k</span><span class="o">++)</span>
            <span class="n">c</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">+=</span> <span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">k</span><span class="o">]</span> <span class="o">*</span> <span class="n">b</span><span class="o">[</span><span class="n">k</span><span class="o">][</span><span class="n">j</span><span class="o">];</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first step in making a concurrent solution to this problem is to
create a <code>Thread</code> subclass which will do some part of the matrix
multiplication. Below is the <code>MatrixThread</code> class which will compute a
number of rows in the answer matrix <code>c</code>.</p>
</div>
<div id="MatrixThreadProgram" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MatrixThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">double</span><span class="o">[][]</span> <span class="n">a</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span><span class="o">[][]</span> <span class="n">b</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">double</span><span class="o">[][]</span> <span class="n">c</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">lower</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">upper</span><span class="o">;</span>  
    
    <span class="kd">public</span> <span class="nf">MatrixThread</span><span class="o">(</span><span class="kt">double</span><span class="o">[][]</span> <span class="n">a</span><span class="o">,</span> <span class="kt">double</span><span class="o">[][]</span> <span class="n">b</span><span class="o">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="kt">double</span><span class="o">[][]</span> <span class="n">c</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lower</span><span class="o">,</span> <span class="kt">int</span> <span class="n">upper</span><span class="o">)</span> <span class="o">{</span>      
        <span class="k">this</span><span class="o">.</span><span class="na">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lower</span> <span class="o">=</span> <span class="n">lower</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">upper</span> <span class="o">=</span> <span class="n">upper</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">lower</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">length</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span>              
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">k</span><span class="o">++)</span>
                    <span class="n">c</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">+=</span> <span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">k</span><span class="o">]</span> <span class="o">*</span> <span class="n">b</span><span class="o">[</span><span class="n">k</span><span class="o">][</span><span class="n">j</span><span class="o">];</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The constructor for <code>MatrixThread</code> stores references to the arrays
corresponding to matrices <em>A</em>, <em>B</em>, and
<em>C</em> as well as lower and upper bounds on the rows of
<em>C</em> to compute.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The body of the <code>run()</code> method is identical
to the sequential solution except that its outermost loop runs only from
<code>lower</code> to <code>upper</code> instead of through all the rows of the result. It’s
critical that each thread is assigned a set of rows that does not
overlap with the rows another thread has. Not only would having multiple
threads compute the same row be inefficient, it would very likely lead
to an incorrect result, as we’ll see in
<a href="chap14.html">Chapter 14</a>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The following client code uses an array of <code>MatrixThread</code> objects to
perform a matrix multiplication. We assume that an <code>int</code> constant named
<code>THREADS</code> has been defined which gives the number of threads we want to
create.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="nc">MatrixThread</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MatrixThread</span><span class="o">[</span><span class="no">THREADS</span><span class="o">];</span>
<span class="kt">int</span> <span class="n">quotient</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">length</span> <span class="o">/</span> <span class="no">THREADS</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">length</span> <span class="o">%</span> <span class="no">THREADS</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">THREADS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">quotient</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="o">)</span>
        <span class="n">rows</span><span class="o">++;</span>
    <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MatrixThread</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">start</span><span class="o">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">rows</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="n">start</span> <span class="o">+=</span> <span class="n">rows</span><span class="o">;</span>
<span class="o">}</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">THREADS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span>
<span class="o">}</span>
<span class="k">catch</span><span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We loop through the array, creating a <code>MatrixThread</code> object for each
location. As in the previous example, we use the approach described in
<a href="chap6.html#_concurrency_arrays">Section 6.11</a> to allocate rows to each thread fairly.
Each new <code>MatrixThread</code> object is given a reference to each of the three
matrices as well as an inclusive starting and an exclusive ending row.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>After the <code>MatrixThread</code> objects are created, we start them running with
the next line of code.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Next, there’s a familiar <code>for</code> loop with the <code>join()</code> calls that force
the main thread to wait for the other threads to finish.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Presumably,
code following this snippet will print the values of the result matrix
or use it for other calculations. If we didn’t use the <code>join()</code>
calls to be sure the threads have finished, we might print out a result
matrix that’s only been partially filled in.</p>
</div>
<div class="paragraph">
<p>We completed the code for threaded matrix multiplication and executed it
on an iMac computer with an Intel Core 2 Duo running at 2.16 Ghz. The program
was executed for matrices of different sizes (<em>n</em> × <em>n</em>).
For each size, the sequential and concurrent execution times in seconds
and the corresponding speedup are listed in the following table.</p>
</div>
<table class="tableblock frame-all grid-all fit-content center">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Size (<em>n</em>)</th>
<th class="tableblock halign-left valign-top"><em>t</em><sub><em>s</em></sub> (s)</th>
<th class="tableblock halign-left valign-top"><em>t</em><sub><em>c</em></sub> (s)</th>
<th class="tableblock halign-left valign-top">Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.013</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.014</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.75</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.39</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15.6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10.7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.45<sup>*</sup></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Only with 1,000 × 1,000 matrices did we see improved
performance when using two threads. In that case, we achieved a speedup
of 1.45, marked with an asterisk. In the other two cases, performance
became worse.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#parallelPiApproximationExercise">Exercise 13.14</a><br>
<a href="chap13.html#matrixSpeedupExercise">Exercise 13.17</a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_concepts_thread_scheduling">13.6. Concepts: Thread scheduling</h3>
<div class="paragraph">
<p>Now that we’ve seen how multiple threads can be used together, a
number of questions arise: Who decides when
these threads run? How is processor time shared between threads? Can we
make any assumptions about the order in which the threads run? Can
we affect this order?</p>
</div>
<div class="paragraph">
<p>These questions focus on thread scheduling. Because different concurrent
systems handle scheduling differently, we’ll only describe scheduling
in Java. Although sequential programming is all about precise control
over what happens <strong>next</strong>, concurrency takes much of this control away
from the programmer. When threads are scheduled and which processor they
run on is handled by a combination of the JVM and the OS. With normal
JVMs, there’s no explicit way to access the scheduling and alter it to
your liking.</p>
</div>
<div class="paragraph">
<p>Of course, there are a number of implicit ways a programmer can affect
scheduling. In Java, as in several other languages and programming
systems, threads have <em>priorities</em>. Higher priority threads run more
often than lower priority threads. Some threads are performing
mission-critical operations which must be carried out as quickly as
possible, and some threads are just doing periodic tasks in the
background. A programmer can set thread priorities accordingly.</p>
</div>
<div class="paragraph">
<p>Setting priorities gives only a very general way of controlling which
thread will run. The threads themselves might have more specific
information about when they will and won’t need processor time. A
thread may need to wait for a specific event and won’t need to run
until then. Java allows threads to interact with the scheduler through
<code>Thread.sleep()</code> and <code>Thread.yield()</code>, which we’ll discuss in
<a href="chap13.html#_syntax_thread_states">Section 13.7</a>, and through the <code>wait()</code>, method which
we’ll discuss in <a href="chap14.html">Chapter 14</a>.</p>
</div>
<div class="sect3">
<h4 id="_nondeterminism">13.6.1. Nondeterminism</h4>
<div class="paragraph">
<p>In Java, the mapping of a thread inside the JVM to a thread in the OS
varies. Some implementations give each Java thread an OS thread, some
put all Java threads on a single OS thread (with the side effect of
preventing parallel execution), and some allow for the possibility of changing
which OS thread a Java thread uses. Thus, the performance and, in some
cases, the correctness of your program might vary, depending on which
system you’re running. This is, yet again, one of those times when Java
is platform independent…​but not entirely.</p>
</div>
<div class="paragraph">
<p>Unfortunately, the situation is even more complicated. Making threads
part of your program means that the same program could run differently
on the <strong>same</strong> system. The JVM and the OS have to cooperate to schedule
threads, and both programs are complex mountains of code which try to
balance many factors. If you create three threads, there’s no guarantee
that the first will run first, the second second, and the third third,
even if it happens that way the first 10 times you run the program.
<a href="chap13.html#executionOrderExercise">Exercise 13.18</a> shows that the pattern of thread
execution can vary a lot.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#executionOrderExercise">Exercise 13.18</a></p>
</div>
</div>
</div>
<div class="paragraph">
<p>In all the programs before this chapter, the same sequence of input
would always produce the same sequence of output. Perhaps the biggest
hurdle created by this nondeterminism is that programmers must shift
their paradigm considerably. The processor can switch between executions
of threads at any time, even in the middle of operations. Every possible
interleaving of thread execution could crop up at some point. Unless you
can be sure that your program behaves properly for all of them, you might
never be able to debug your code completely. What’s so insidious about
nondeterministic bugs is that they can occur rarely and be almost
impossible to reproduce. In this chapter, we’ve introduced how to create and
run threads, but making these threads interact properly is a major
problem we tackle in subsequent chapters.</p>
</div>
<div class="paragraph">
<p>After those dire words of warning, we’d like to remind you that
nondeterminism is not in itself a bad thing. Many threaded applications
with a lot of input and output, such as server applications, necessarily
exist in a nondeterministic world. For these programs, many different
sequences of thread execution may be perfectly valid. Each individual
program may have a different definition of correctness. For example, if
a stock market server receives two requests to buy the last share of a
particular stock at almost the same time from two threads corresponding
to two different clients, it might be correct for either one of them to
get that last share. However, it would never be correct for <strong>both</strong> of
them to get it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_polling">13.6.2. Polling</h4>
<div class="paragraph">
<p>So far the only mechanism we’ve introduced for coordinating different
threads is using the <code>join()</code> method to wait for a thread to end.
Another technique is <em>polling</em>, or <em>busy waiting</em>. The idea is to keep
checking the state of one thread until it changes.</p>
</div>
<div class="paragraph">
<p>There are a number of problems with this approach. The first is that it
wastes CPU cycles. Those cycles spent by the waiting thread continually
checking could have been used productively by some other thread in the
system. The second problem is that we have to be certain that the state
of the thread we’re waiting for won’t change back to the original state
or to some other state. Because of the unpredictability of scheduling,
there’s no guarantee that the waiting thread will read the state of the
other thread when it has the correct value.</p>
</div>
<div class="paragraph">
<p>We bring up polling partly because it has a historical importance to
parallel programming, partly because it can be useful in solving some
problems in this chapter, and partly because we want you to understand
the reasons why we need better techniques for thread communication.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#pollingArraySumExercise">Exercise 13.11</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_syntax_thread_states">13.7. Syntax: Thread states</h3>
<div class="paragraph">
<p>A widely used Java tool for manipulating scheduling is the
<code>Thread.sleep()</code> method. This method can be called any time you want a
thread to do nothing for a set period of time. Until the sleep timer
expires, the thread will not be scheduled for any CPU time, unless it’s
interrupted. To make a thread of execution sleep, call <code>Thread.sleep()</code>
in that thread of execution with a number of milliseconds as a
parameter. For example, calling <code>Thread.sleep(2000)</code> will make the
calling thread sleep for two full seconds.</p>
</div>
<div class="paragraph">
<p>Another useful tool is the <code>Thread.yield()</code> method. It gives up use of
the CPU so that the next waiting thread can run. To use it, a thread
calls <code>Thread.yield()</code>. This method is useful in practice, but
according to official documentation, the JVM doesn’t <strong>have</strong> to do to
anything when a <code>Thread.yield()</code> call happens. The Java specification
doesn’t demand a particular implementation. A JVM could ignore a
<code>Thread.yield()</code> call completely, but most JVMs will move on to the next
thread in the schedule.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="chap13.html#sleepAndYieldMethodsExercise">Exercise 13.3</a><br>
<a href="chap13.html#sleepTimerExercise">Exercise 13.13</a></p>
</div>
</div>
</div>
<div id="figure-thread_states" class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/thread-states.svg" alt="thread states" width="80%">
</div>
<div class="title">Figure 13.7 Thread states and transitions.</div>
</div>
<div class="paragraph">
<p><a href="chap13.html#figure-thread_states">Figure 13.7</a> shows the lifecycle of a thread. A
thread begins its life in the New Thread state, after the constructor is
called. When the <code>start()</code> method is called, the thread begins to run
and transitions to the Runnable state. Being Runnable doesn’t
necessarily mean that the thread is executing at any given moment but
that it’s ready to run at any time. When in the Runnable state, a
thread may call <code>Thread.yield()</code>, relinquishing use of the processor,
but it will still remain Runnable.</p>
</div>
<div class="paragraph">
<p>However, if a thread goes to sleep with a <code>Thread.sleep()</code> call, waits
for a condition to be true using a <code>wait()</code> call, or performs a blocking
I/O operation, the thread will transition to the Not Runnable state. Not
Runnable threads cannot be scheduled for processor time until they wake
up, finish waiting, or complete their I/O. The final state is
Terminated. A thread becomes Terminated when its <code>run()</code> method
finishes. A Terminated thread cannot become Runnable again and is no
longer a separate thread of execution.</p>
</div>
<div class="paragraph">
<p>Any object with a type that’s a subclass of <code>Thread</code> can tell you its
current state using the <code>getState()</code> method. This method returns an
<em>enum</em> type, whose value must come from a fixed list of constant
objects. These objects are <code>Thread.State.NEW</code>, <code>Thread.State.RUNNABLE</code>,
<code>Thread.State.BLOCKED</code>, <code>Thread.State.WAITING</code>,
<code>Thread.State.TIMED_WAITING</code>, and <code>Thread.State.TERMINATED</code>. Although
the others are self explanatory, we lump the <code>Thread.State.BLOCKED</code>,
<code>Thread.State.WAITING</code>, and <code>Thread.State.TIMED_WAITING</code> values into
the Not Runnable state, since the distinction between the three isn’t
important for us.</p>
</div>
<div class="paragraph">
<p>Threads also have priorities in Java. When an object that’s a subclass
of <code>Thread</code> is created in Java, its priority is initially the same as
the thread that creates it. Usually, this priority is
<code>Thread.NORM_PRIORITY</code>, but there are some special cases when it’s a
good idea to raise or lower this priority. Avoid changing thread
priorities because it increases platform dependence and because the
effects are not always predictable. Be aware that priorities exist, but
don’t use them unless and until you have a good reason.</p>
</div>
<div class="exampleblock">
<div class="title">Example 13.12 Military marching</div>
<div class="content">
<div class="paragraph">
<p>Let’s apply the ideas discussed above to a lighthearted example. You
might be familiar with sound of soldiers marching: “Left, Left, Left,
Right, Left!” We can design a thread that prints <code>Left</code> and another
thread that prints <code>Right</code>. We can combine the two to print the correct
sequence for marching and loop the whole thing 10 times so that we can
see how accurately we can place the words. We want to use the scheduling tools
discussed above to get the timing right. Let’s try <code>Thread.sleep()</code>
first.</p>
</div>
<div id="LeftThreadProgram" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LeftThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Left "</span><span class="o">);</span>  <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Left "</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Left "</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span> <span class="o">}</span>  <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="k">catch</span><span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Left"</span><span class="o">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Inside, the <code>for</code> loop, this thread prints out <code>Left</code> three times.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The, it waits for 10 milliseconds.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Finally, it prints out <code>Left</code> again and repeats the loop.</td>
</tr>
</tbody></table>
</div>
<div id="RightThreadProgram" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RightThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> 
        <span class="k">try</span> <span class="o">{</span>
			<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
			<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span> 
				<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Right "</span><span class="o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
				<span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
			<span class="o">}</span>
		<span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This thread waits for 5 milliseconds to get synchronized.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inside its <code>for</code> loop, it prints out <code>Right</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then, it waits for 10 milliseconds and repeats the loop.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The driver program below creates a thread for each of these
classes and then starts them. If you run this program, you should see 10
lines of <code>Left Left Left Right Left</code>, but there are a few problems.</p>
</div>
<div id="MilitaryMarchingProgram" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MilitaryMarching</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">LeftThread</span> <span class="n">left</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LeftThread</span><span class="o">();</span>
        <span class="nc">RightThread</span> <span class="n">right</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RightThread</span><span class="o">();</span>
        <span class="n">left</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">right</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">left</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
            <span class="n">right</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>       
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first problem is that we have to wait some amount of time between
calls. We could shorten the <code>Thread.sleep()</code> calls, but there are limits
on the resolution of the timer. The bigger problem is that the two
threads can sometimes get out of sync. If you run the program many
times, you might see a <code>Right</code> out of place once in a while. If you
increase the repetitions of the <code>for</code> loops to a larger number, the
errors will become more likely. Whether or not you see errors is somewhat system
dependent. We can try <code>Thread.yield()</code> instead of <code>Thread.sleep()</code>.</p>
</div>
<div id="LeftYieldThreadProgram" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LeftYieldThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Left "</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Left "</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Left "</span><span class="o">);</span>              
            <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>         
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Left"</span><span class="o">);</span>                 
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div id="RightYieldThreadProgram" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RightYieldThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>         
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span> 
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Right "</span><span class="o">);</span>         
            <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These new versions of the two classes have essentially replaced calls to
<code>Thread.sleep()</code> with calls to <code>Thread.yield()</code>. Without the need for
exception handling, the code is simpler, but we’ve traded one set of
problems for another. If there are other threads operating in the same
application, they’ll be scheduled in ways that will interfere with the
pattern of yielding. If you’re running this code on a machine
with a single processor and a single core, you have a good chance of
seeing something which matches the expected output. However, if you’re running
it on multiple cores, everything will be jumbled. It’s likely that
the <code>LeftYieldThread</code> will be running on one processor with the
<code>RightYieldThread</code> on another. In that case, neither has any competition
to yield to.</p>
</div>
<div class="paragraph">
<p>Finally, let’s look at a polling solution which still falls short of
the mark. To do this, we need state variables inside of each class to
keep track of whether or not it’s done. Each thread needs a reference
to the other thread to make queries, and the driver program must be
updated to add these in before starting the threads.</p>
</div>
<div id="LeftPollingThreadProgram" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LeftPollingThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">RightPollingThread</span> <span class="n">right</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRight</span><span class="o">(</span><span class="nc">RightPollingThread</span> <span class="n">right</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="n">right</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Left "</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Left "</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Left "</span><span class="o">);</span>          
            <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>            
            <span class="k">while</span><span class="o">(!</span><span class="n">right</span><span class="o">.</span><span class="na">isDone</span><span class="o">());</span>           
            <span class="n">right</span><span class="o">.</span><span class="na">setDone</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>                     
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Left"</span><span class="o">);</span>                 
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isDone</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">done</span><span class="o">;</span> <span class="o">}</span>    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDone</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span> <span class="n">done</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div id="RightPollingThreadProgram" class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RightPollingThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">LeftPollingThread</span> <span class="n">left</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>   
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLeft</span><span class="o">(</span><span class="nc">LeftPollingThread</span> <span class="n">left</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="n">left</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> 
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>             
            <span class="k">while</span><span class="o">(!</span><span class="n">left</span><span class="o">.</span><span class="na">isDone</span><span class="o">());</span>            
            <span class="n">left</span><span class="o">.</span><span class="na">setDone</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>            
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Right "</span><span class="o">);</span>         
            <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isDone</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">done</span><span class="o">;</span> <span class="o">}</span>    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDone</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span> <span class="n">done</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Whether single core or multicore, this solution will always give the
right output. Or it should. Java experts will point out that we are
violating a technicality of the Java Memory Model. Because we’re not
using synchronization tools, we have no guarantee that the change of the
<code>done</code> variable will even be <strong>visible</strong> from one thread to another. In
practice, this problem should affect you rarely, but to be safe, both of
the <code>done</code> variables should be declared with the keyword <code>volatile</code>.
This keyword makes Java aware that the value may be accessed at any time
from arbitrary threads.</p>
</div>
<div class="paragraph">
<p>Another issue is that there’s <strong>no</strong> parallel execution. Each thread must wait
for the other to complete. Of course, this problem does not benefit from
a parallelism, but applying this solution to problems which can
benefit from parallelism might cause performance problems. Each thread
wastes time busy waiting in a <code>while</code> loop for the other to be done,
consuming CPU cycles while it does so. You’ll notice that the code
must still be carefully written. Each thread must set the other thread’s
<code>done</code> value to <code>false</code>. If threads were responsible for setting their
own <code>done</code> values to <code>false</code>, one thread might print its information and
go back to the top of the <code>for</code> loop before the other thread had reset
its own <code>done</code> to <code>false</code>.</p>
</div>
<div class="paragraph">
<p>In short, coordinating two or more threads together is a difficult
problem. None of the solutions we give here are fully acceptable. We
introduce better tools for coordination and synchronization in
<a href="chap14.html">Chapter 14</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_solution_deadly_virus">13.8. Solution: Deadly virus</h3>
<div class="paragraph">
<p>Finally, we give the solution to the deadly virus problem. By this
point, the threaded part of this problem should not seem very difficult.
It’s simpler than some of the examples, such as matrix multiplication.
We begin with the worker class <code>FactorThread</code> that can be spawned as a
thread.</p>
</div>
<div id="FactorThreadProgram" class="listingblock">
<div class="title">Program 13.1 Thread class used to find the sum of the two factors of a large odd composite.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FactorThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>  
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">lower</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">upper</span><span class="o">;</span> 
    
    <span class="kd">public</span> <span class="nf">FactorThread</span><span class="o">(</span><span class="kt">long</span> <span class="n">lower</span><span class="o">,</span> <span class="kt">long</span> <span class="n">upper</span><span class="o">)</span> <span class="o">{</span>     
        <span class="k">this</span><span class="o">.</span><span class="na">lower</span> <span class="o">=</span> <span class="n">lower</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">upper</span> <span class="o">=</span> <span class="n">upper</span><span class="o">;</span>     
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span> 
        <span class="k">if</span><span class="o">(</span><span class="n">lower</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// Only check odd numbers</span>
            <span class="n">lower</span><span class="o">++;</span>        
        <span class="k">while</span><span class="o">(</span><span class="n">lower</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="nc">Factor</span><span class="o">.</span><span class="na">NUMBER</span> <span class="o">%</span> <span class="n">lower</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Security code: "</span> <span class="o">+</span> <span class="o">(</span><span class="n">lower</span> <span class="o">+</span> <span class="nc">Factor</span><span class="o">.</span><span class="na">NUMBER</span> <span class="o">/</span> <span class="n">lower</span><span class="o">));</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">lower</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="o">}</span>           
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The constructor for <code>FactorThread</code> takes an upper and lower bound,
similar to <code>MatrixThread</code>. Once a <code>FactorThread</code> object has those
bounds, it can search between them. The number to factor is stored in
the <code>Factor</code> class. If any value divides that number evenly, it must be
one of the factors, making the other factor easy to find, sum, and print
out. We have to add a couple of extra lines of code to make sure that we
only search the odd numbers in the range. This solution is tuned for
efficiency for this specific security problem. A program to find general
prime factors would have to be more flexible. Next, let’s examine the
driver program <code>Factor</code>.</p>
</div>
<div id="FactorProgram" class="listingblock">
<div class="title">Program 13.2 Driver class which creates threads to lower the average search time for the factors of a large odd composite.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Factor</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">THREADS</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">NUMBER</span> <span class="o">=</span> <span class="mi">59984005171248659L</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">FactorThread</span><span class="o">[]</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FactorThread</span><span class="o">[</span><span class="no">THREADS</span><span class="o">];</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="kt">long</span> <span class="n">root</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span><span class="nc">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="no">NUMBER</span><span class="o">);</span> <span class="c1">// Go to square root</span>
        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>  <span class="c1">// No need to test 2       </span>
        <span class="kt">long</span> <span class="n">quotient</span> <span class="o">=</span> <span class="n">root</span> <span class="o">/</span> <span class="no">THREADS</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">root</span> <span class="o">%</span> <span class="no">THREADS</span><span class="o">;</span>
        
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">THREADS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">work</span> <span class="o">=</span> <span class="n">quotient</span><span class="o">;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span><span class="o">)</span>
                <span class="n">work</span><span class="o">++;</span>
            <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FactorThread</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">work</span><span class="o">);</span> <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
            <span class="n">start</span> <span class="o">+=</span> <span class="n">work</span><span class="o">;</span>
        <span class="o">}</span>   
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">THREADS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="n">threads</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="o">}</span>
        <span class="k">catch</span><span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Static constants hold both the number to be factored and the number of
threads.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>In the <code>main()</code> method, we create an array of threads for
storage.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then, we create and start each <code>FactorThread</code> object, assigning upper and
lower bounds at the same time, using the standard technique from
<a href="chap6.html#_concurrency_arrays">Section 6.11</a> to divide the work fairly. Because we
know the number we’re dividing isn’t even, we start with 3. By only
going up to the square root of the number, we know that we will only
find the smaller of the two factors. In that way we can avoid having one
thread find the smaller while another is finds the larger.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Afterward, we have the usual <code>join()</code> calls to make sure that all the
threads are done. In this problem, these calls are unnecessary. One
thread will print out the correct security code, and the others will
search fruitlessly. If the program went on to do other work, we might
need to let the other threads finish or even interrupt them. Don’t
forget <code>join()</code> calls since they’re usually very important.</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_summary_5">13.9. Summary</h3>
<div class="paragraph">
<p>In this chapter we’ve explored
two strategies to obtain a concurrent solution to programming problems.
One strategy, task decomposition, splits a task into two or more
subtasks. These subtasks can then be packaged as Java threads and
executed on different cores of a multicore processor. Another strategy,
domain decomposition, partitions input data into smaller chunks and
allows different threads to work concurrently on each chunk of data.</p>
</div>
<div class="paragraph">
<p>A concurrent solution to a programming problem can sometimes execute more quickly
than a sequential solution. Speedup measure how effective a concurrent
solution is at exploiting the architecture of a multicore processor.
Note that not all concurrent programs lead to speedup as some run slower
than their sequential counterparts. Writing a concurrent program is a
challenge that forces us to divide up work and data in a
way that best exploits the available processors and OS.</p>
</div>
<div class="paragraph">
<p>Java provides a rich set of primitives and syntactic elements to write
concurrent programs, but only a few of these were introduced in this
chapter. Subsequent chapters give additional tools to code more complex
concurrent programs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_13">13.10. Exercises</h3>
<div class="paragraph">
<p><strong>Conceptual Problems</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a id="threadMethodsExercise"></a> The <code>start()</code>, <code>run()</code>, and <code>join()</code>
methods are essential parts of the process of using threads in Java.
Explain the purpose of each method.</p>
</li>
<li>
<p><a id="extendingThreadExercise"></a> What’s the difference between
extending the <code>Thread</code> class and implementing the <code>Runnable</code> interface?
When should you use one over the other?</p>
</li>
<li>
<p><a id="sleepAndYieldMethodsExercise"></a> How do the <code>Thread.sleep()</code> method and
the <code>Thread.yield()</code> method each affect thread scheduling?</p>
</li>
<li>
<p><a id="mathExpressionTimingExercise"></a> Consider the expression in
<a href="chap13.html#mathExpressionTasksExample">Example 13.2</a>. Suppose that the multiply and
exponentiation operations require 1 and 10 time units, respectively.
Compute the number of time units required to evaluate the expression as
in <a href="chap13.html#figure-math_evaluation">Figure 13.2</a>(a) and (b).</p>
</li>
<li>
<p><a id="quad-coreExercise"></a> Suppose that a computer has one
quad-core processor. Can the tasks in <a href="chap13.html#videoGameTasksExample">Example 13.1</a> and <a href="chap13.html#mathExpressionTasksExample">Example 13.2</a> be further subdivided to
improve performance on four cores? Why or why not?</p>
</li>
<li>
<p><a id="speedupExercise"></a> Consider the definition of speedup from
<a href="chap13.html#_examples_concurrency_and_speedup">Section 13.5</a>. Let’s assume you have a
job 1,000,000 units in size. A thread can process 10,000 units of work
every second. It takes an additional 100 units of work to create a new
thread. What’s the speedup if you have a dual-core processor and create
2 threads? What if you have a quad-core processor and create 4 threads?
Or an 8-core processor and create 8 threads? You may assume that a
thread does not need to communicate after it’s been created.</p>
</li>
<li>
<p><a id="speedupLimitationsExercise"></a> In which situations can speedup be
smaller than the number of processors? Is it ever possible for speedup
to be greater than the number of processors?</p>
</li>
<li>
<p><a id="AmdahlLawExercise"></a> Amdahl’s Law is a mathematical description of
the maximum amount you can improve a system by only improving a part of
it. One form of it states that the maximum speedup attainable in a
parallel program is 1/(1 - <em>P</em>) where <em>P</em>
is the fraction of the program which can be parallelized to an arbitrary
degree. If 30% of the work in a program can be fully parallelized but
the rest is completely serial, what’s the speedup with two processors? Four?
Eight? What implications does Amdahl’s Law have?</p>
</li>
<li>
<p><a id="minimumTimeForTasksExercise"></a> Consider the following table of
tasks:</p>
<table class="tableblock frame-all grid-all fit-content center">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-middle">Task</th>
<th class="tableblock halign-center valign-middle">Time</th>
<th class="tableblock halign-center valign-middle">Concurrency</th>
<th class="tableblock halign-left valign-middle">Dependency</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Washing Dishes</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">30</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Cooking Dinner</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">45</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Washing Dishes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Cleaning Bedroom</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">10</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Cleaning Bathroom</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">30</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-middle"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Doing Homework</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">30</p></td>
<td class="tableblock halign-center valign-middle"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-middle"><p class="tableblock">Cleaning Bedroom</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In this table, the <strong>Time</strong> column gives the number of minutes a task
takes to perform with a single person, the <strong>Concurrency</strong> column gives
the maximum number of people who can be assigned to a task, and the
<strong>Dependency</strong> column shows which tasks can’t start until other tasks
have been finished. Assume that people assigned to a given task can
perfectly divide the work. In other words, the time a task takes is the
single person time divided by the number of people assigned. What’s the
minimum amount of time needed to perform all tasks with only a single
person? What is the minimum amount of time needed to perform all tasks
with an unlimited number of people? What’s the smallest number of
people needed to achieve this minimum time?</p>
</div>
</li>
<li>
<p><a id="sharedThreadVariableExercise"></a> Consider the following code snippet.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">x</span> <span class="o">=</span> <span class="mi">13</span><span class="o">;</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">10</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Consider this snippet as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">x</span> <span class="o">=</span> <span class="mi">7</span><span class="o">;</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we assume that these two snippets of code are running on separate
threads but that <code>x</code> is a shared variable, what are the possible values
<code>x</code> could have after both snippets have run? Remember that the execution
of these snippets can be interleaved in <strong>any</strong> way.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Programming Practice</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p><a id="pollingArraySumExercise"></a> Re-implement the array summing problem from
<a href="chap13.html#arraySummationExample">Example 13.10</a> using polling instead of <code>join()</code>
calls. Your program should not use a single call to <code>join()</code>. Polling is
not an ideal way to solve this problem, but it’s worth thinking about the technique.</p>
</li>
<li>
<p><a id="parallelAudioProcessingExercise"></a> Composers often work with multiple tracks
of music. One track might contain solo vocals, another drums, a third
one violins, and so on. After recording the entire take, a mix engineer
might want to apply special effects such as an echo to one or more
tracks.</p>
<div class="paragraph">
<p>To understand how to add echo to a track, suppose that the track
consists of a list of audio samples. Each sample in a mono (not stereo)
track can be stored as a <code>double</code> in an array. To create an echo effect,
we combine the current value of an audio sample with a sample from a
fixed time earlier. This time is called the <em>delay</em> parameter. Varying
the delay can produce long and short echoes.</p>
</div>
<div class="paragraph">
<p>If the samples are stored in array <code>in</code> and the delay parameter is
stored in variable <code>delay</code> (measured in number of samples), the following code snippet can be used to
create array <code>out</code> which contains the sound with an echo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">double</span><span class="o">[]</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="o">[</span><span class="n">in</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">delay</span><span class="o">];</span>
<span class="c1">// Sound before echo starts</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">delay</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
    <span class="n">out</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">in</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
<span class="c1">// Sound with echo</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">delay</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
    <span class="n">out</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">in</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">in</span><span class="o">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">delay</span><span class="o">];</span>
<span class="c1">// Echo after sound is over</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">out</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
    <span class="n">out</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">in</span><span class="o">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">delay</span><span class="o">];</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Parameters <code>a</code> and <code>b</code> are used to control the nature of the echo. When
<code>a</code> is <code>1</code> and <code>b</code> is <code>0</code>, there is no echo. When <code>a</code> is <code>0</code> and <code>b</code> is
<code>1</code>, there is no mixing. Audio engineers will control the values of <code>a</code>
and <code>b</code> to create the desired echo effect.</p>
</div>
<div class="paragraph">
<p>Write a threaded program that computes the values in <code>out</code> in parallel
for an arbitrary number of threads.</p>
</div>
</li>
<li>
<p><a id="sleepTimerExercise"></a> Write a program which takes a number of
minutes and seconds as input. In this program, implement a timer using
<code>Thread.sleep()</code> calls. Each second, print the remaining time to the
screen. How accurate is your timer?</p>
</li>
<li>
<p><a id="parallelPiApproximationExercise"></a> As you know,
<em>π</em> ≈ 3.1416. A more precise value can be found by writing a program which
approximates the area of a circle. The area of a circle can be
approximated by summing up the area of rectangles filling curve of the
arc of the circle. As the width of the rectangle goes to zero, the
approximation becomes closer and closer to the true area. If a circle with radius
<em>r</em> is centered at the origin, its height <em>y</em> at a particular
distance <em>x</em> is given by the following formula.</p>
<div class="imageblock text-center">
<div class="content">
<img src="chapters/13-concurrency/images/circleHeight.svg" alt="circleHeight" width="15%">
</div>
</div>
<div class="paragraph">
<p>Write a parallel implementation of this problem which divides up
portions of the arc of the circle among several threads and then sums
the results after they all finish. By setting <em>r</em> = 2, you
need only sum one quadrant of a circle to get <em>π</em>. You’ll need to
use a very small rectangle width to get an accurate answer.
When your program finishes running, you can compare your value against
<code>Math.PI</code> for accuracy.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Experiments</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic" start="15">
<li>
<p><a id="executionVariationExercise"></a> Use the <code>currentTimeMillis()</code> method
to measure the time taken to execute a relatively long-running piece of
Java code you’ve written. Execute your program several times and
compare the execution time you obtain during different executions. Why
do you think the execution times are different?</p>
</li>
<li>
<p><a id="threadOverheadExercise"></a> Thread creation overhead is an
important consideration in writing efficient parallel programs. Write a
program which creates a large number of threads which do nothing. Test
how long it takes to create and join various numbers of threads. See if
you can determine how long a single thread creation operation takes on
your system, on average.</p>
</li>
<li>
<p><a id="matrixSpeedupExercise"></a> Create serial and concurrent
implementations of matrix multiplication like those described in
<a href="chap13.html#matrixMultiplicationExample">Example 13.11</a>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Experiment with different matrix sizes and thread counts to see how
the speedup performance changes. If possible, run your tests on machines
with different numbers of cores or processors.</p>
</li>
<li>
<p>Given a machine with <em>k</em> &gt; 1 cores, what is the maximum
speedup you can expect to obtain?</p>
</li>
</ol>
</div>
</li>
<li>
<p><a id="executionOrderExercise"></a> Repeatedly run the code in
<a href="chap13.html#arrayOfThreadsExample">Example 13.7</a> which creates several
<code>NumberedThread</code> objects. Can you discover any patterns in the order
that the threads print? Add a loop and some additional instrumentation
to the <code>NumberedThread</code> class which will allow you to measure how long
each thread runs before the next thread has a turn.</p>
</li>
<li>
<p><a id="arraySummingSpeedupExercise"></a> Create serial and parallel implementations of
the array summing problem solved in <a href="chap13.html#arraySummationExample">Example 13.10</a>.
Experiment with different array sizes and thread counts to see how
performance changes. How does the speedup differ from matrix multiply?
What happens if you simply sum the numbers instead of taking the sine
first?</p>
</li>
<li>
<p><a id="treeSummationExercise"></a> The solution to the array summing problem in
<a href="chap13.html#arraySummationExample">Example 13.10</a> seems to use concurrency
half-heartedly. After all the threads have computed their sums, the main
thread sums up the partial sums sequentially.</p>
<div class="paragraph">
<p>An alternative approach is to sum up the partial sums concurrently. Once
a thread has computed the sum of the sines of each partition, the sums
of each pair of neighboring partitions should be merged into a single
sum. The process can be repeated until the final sum has been computed.
At each step, half of the remaining threads will have nothing left to do
and will stop. The pattern of summing is like a tree which starts with
<em>k</em> threads working at the first stage,
<em>k</em>/2 working at the second stage,
<em>k</em>/4 working at the third, and so on, until a
single thread completes the summing process.</p>
</div>
<div id="figure-tree_summation" class="imageblock">
<div class="content">
<img src="chapters/13-concurrency/images/treesummation.svg" alt="treesummation" width="100%">
</div>
<div class="title">Figure 13.8 Example of concurrent tree-style summation with 8 threads.</div>
</div>
<div class="paragraph">
<p>Update the <code>run()</code> method in the <code>SumThread</code> class so that it adds its
assigned elements as before and then adds its neighbor’s sum to its own.
To do so, it must use the <code>join()</code> method to wait for the neighboring
thread. It should perform this process repeatedly. After summing their
own values, each even numbered thread should add in the partial sum from
its neighbor. At the next step, each thread with a number divisible by 4
should add the partial sum from its neighbor. At the next step, each
thread with a number divisible by 8 should add the partial sum from its
neighbor, and so on. Thread 0 will perform the final summation.
Consequently, the main thread only needs to wait for thread 0. So that
each thread can wait for other threads, the <code>threads</code> array will need to
be a static field. <a href="chap13.html#figure-tree_summation">Figure 13.8</a> illustrates this
process.</p>
</div>
<div class="paragraph">
<p>Once you’ve implemented this design, test it against the original
<code>SumThread</code> class to see how it performs. Restrict the number of threads
you create to a power of 2 to make it easier to determine which threads
wait and which threads terminate.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div></div>

<nav>
  <a rel="prev" href="chap12.html" class="nav nav-prev" title="Previous page" aria-label="Previous page" aria-keyshortcuts="Left">
        <i class="fa fa-angle-left"></i>
     </a>
  <a rel="next" href="chap14.html" class="nav nav-next" title="Next page" aria-label="Next page" aria-keyshortcuts="Right">
        <i class="fa fa-angle-right"></i>
     </a>
  <div style="clear: both"></div>
</nav>
<div id="footer">
<div id="footer-text">
Last updated 2024-05-22 11:27:29 -0400
</div>
</div>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-VEDGKRPMMK"></script>
          <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-VEDGKRPMMK');
          </script>

</body>
  <script>
  function isInViewport(ele) {
    const rect = ele.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight)
    );
  }
  function yPosition (ele) {
    const rect = ele.getBoundingClientRect();
    return (rect.top - 20); // 20px above
  }
  let curr = document.getElementsByClassName('current');
  if (!isInViewport(curr[curr.length - 1])) {
    document.getElementById('toc').scrollTo({
      top: yPosition(curr[0]),
      left: 0,
      behavior: 'smooth'
    });
  }

  /* For page navigation */
  function gotoPage(selector) {
    const button = document.querySelector(selector);
    if (button)
      window.location.href = button.href;
  }
  document.addEventListener('keydown', e => {
    if (e.shiftKey)
      return;
    switch (e.key) {
      case 'ArrowRight':
        e.preventDefault();
        gotoPage('.nav-next');
        break;
      case 'ArrowLeft':
        e.preventDefault();
        gotoPage('.nav-prev');
        break;
    }
  });
  </script>
  </html>